{# core import #}
{% import 'scarfinity/template/components/navigation/breadcrumbs.twig' as _breadcrumbs %}

{# import #}
{% import 'scarfinity/template/components/cart/header-navigation.twig' as headerNavigation %}
{% import 'scarfinity/template/components/cart/price-calculation.twig' as _priceCalculation %}
{% import 'scarfinity/template/components/cart/payments.twig' as _payments %}
{% import 'scarfinity/template/components/cart/bottom-navigation.twig' as _bottomNavigation %}
{% import 'scarfinity/template/components/cart/radio-box-group.twig' as _radioBoxGroup %}
{% import 'scarfinity/template/components/utility/select-box.twig' as _selectBox %}

{{ header }}
{{ _breadcrumbs.Breadcrumbs({ breadcrumbs: breadcrumbs, topOffset: 0 }) }}
<div id="checkout-checkout" class="container">
    <div class="row">
        <div class="col-md-12 col-sm-no-padding">
        {% if error_warning %}
            <div class="alert alert-danger alert-dismissible"><i class="fa fa-exclamation-circle"></i> {{ error_warning }}
                <button type="button" class="close" data-dismiss="alert">&times;</button>
            </div>
        {% endif %}

        <div id="cart" class="container">
          <div class="row">
            <h1>{{ heading_title }}</h1>
            <br>
            <div class="cart">
                {{ headerNavigation.HeaderNavigation({ step:'2' }) }}
                <div class="nav nav-tabs cart-checkout-navigation hidden">
                    <a data-toggle="tab" href="#cart-checkout-requisites">1</a>
                    <a data-toggle="tab" href="#cart-checkout-payments">2</a>
                </div>
                <div id="checkout-errors"></div>
                <div id="cart-checkout" class="tab-content">
                    <div class="tab-pane active" id="cart-checkout-requisites">
                        <form class="requisites">
                            <div class="requisites-row row">
                                <div class="col-md-6 col-sm-12">
                                    <span class="requisites-title"><b>Состав </b>заказа</span>
                                    {{ _priceCalculation.priceCalculation({ productsTotal: 0, deliveryTotal: 0 }) }}
                                </div>
                                <div class="col-md-6 col-sm-12">
                                    <span class="requisites-title"><b>Контактная </b>информация</span>
                                    <div id="cart-checkout-requisites-login"></div>
                                </div>
                                <div class="requisites-row__delim hidden-sm"></div>
                            </div>
                        </form>
                    </div>
                    <div class="tab-pane" id="cart-checkout-payments">
                        <div class="payments">
                            <div class="requisites-row row">
                                <div class="col-md-6 col-sm-12">
                                    <span class="requisites-title"><b>Аддрес </b>доставки</span>
                                    <div id="cart-checkout-requisites-shipping" class=""></div>
                                    <hr >
                                    <span class="requisites-title"><b>Способ </b>доставки</span>
                                    <div id="cart-checkout-requisites-shipping-method"></div>
                                </div>
                                <div class="col-md-6 col-sm-12">
                                    <span class="requisites-title">Способ <b>оплаты</b></span>
                                    <div id="cart-checkout-payments-method"></div>
                                </div>
                                <div class="requisites-row__delim hidden-sm"></div>
                            </div>
                        </div> 
                    </div>
                </div>
              {{
                _bottomNavigation.BottomNavigation({
                  prevHref: continue,
                  prevTitle: button_shopping,
                  nextHref: checkout,
                  nextTitle: button_checkout,
                  disabled: true
                })
              }}
            </div>
          </div>
        </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    function goTo(step) {
        $('#checkout-checkout .cart__header-navigation').attr("data-step", step);
        $('.cart-header-navigation-item').removeClass('active');
        $('.cart-header-navigation-item[data-value="' + step + '"]').addClass('active');
    }

    function nextButtonSet(data) {
        console.log(data);
        if(data) {
            var nextButton = $('#cart-button-next');
            var nextButtonLink = nextButton.find('a');

            if(nextButton && nextButtonLink) {
                if(data['label']) {
                    nextButtonLink.text(data['label']);
                }

                if(data['action']) {
                    nextButton.attr('data-action', data['action']);
                }
            }
        }
    }
</script>

{# Первоначальная загрука #}
{# Если пользователь не залогинен, вывести форму для ввода(регистрации) #}
{# нового пользователя #}
{# Если пользователь зарегистрирован, вывести форму #}
{# с данными о данном заказчике с возможностью изменения #}
<script type="text/javascript">
    $(document).ready(function() {
        $.ajax({
            url: 'index.php?route=checkout/login',
            dataType: 'html',
            beforeSend: function() {
                goTo(2);
            },
            success: function(html) {
                $('#cart-checkout-requisites-login').html(html);

                nextButtonSet({
                    label: 'Доставка и оплата',
                    action: 'customerSave'
                });
            },
            error: function(xhr, ajaxOptions, thrownError) {
                alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
            },
            complete: function() {
                $('#cart-button-next').prop('disabled', false);
            }
        });
    });
</script>

{# После ввода пользователем личной информации #}
{# Сохранить данную информацию #}
<script type="text/javascript">
    var checkout = {
        customer: {
            firstname: '',
            lastname: '',
            telephone: '',
            email: ''
        },
        login: {
            email: '',
            password: '',
        },
        shipping_address: {
            country_id: '176',
            city: '',
            address_1: '',
            address_2: '',
            postcode: '',
            zone_id: '1',
            firstname: '',
            lastname: '',
            company: '',
        },
        shipping_method: {
            shipping_method: ''
        },
        payment_method: {
            payment_method: ''
        },
        terms: {
            agree: false
        },
        additional: {
            comment: ''
        },
        __error: function(action) {
            return function(xhr, ajaxOptions, thrownError) {
                alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);

                if(action) action();
            }
        },
        customerLogin: function(actions) {
            var checkout = this;

            $.ajax({
                url: 'index.php?route=checkout/login/save',
                type: 'post',
                data: checkout.login,
                dataType: 'json',
                beforeSend: function() {
                    $('#button-login').button('loading');
                },
                complete: function() {
                    $('#button-login').button('reset');
                },
                success: function(json) {
                    console.log(json);
                    if (json['redirect']) {
                        location = json['redirect'];
                    } else if (json['error']) {
                        if(actions['error']) actions['error'](json['error']);
                    }
                },
                error: function(xhr, ajaxOptions, thrownError) {
                    alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                }
            });
        },
        customerSave: function(actions = {}) {
            var checkout = this;

            $.ajax({
                url: 'index.php?route=checkout/simple/customerSave',
                data: checkout.customer,
                method: 'post',
                dataType: 'json',
                beforeSend: function() {},
                success: function(json) {
                    if(json['redirect']) {
                        location = json['redirect'];
                    } else if(json['error']) {
                        console.warn('Customer Save - has errors!');
                        if(actions['error']) actions['error'](json['error']);
                    } else {
                        console.log('Customer save succesed!');
                        if(actions['success']) actions['success'](json);
                    }
                },
                error: checkout.__error(actions['error'])
            });
        },
        shippingAddressGet: function(actions = {}) {
            var checkout = this;

            $.ajax({
                url: 'index.php?route=checkout/simple/shippingAddressGet',
                dataType: 'html',
                beforeSend: actions['beforeSend'],
                success: function(html) {
                    console.log('Sipping loaded!');
                    if(actions['success']) actions['success'](html);
                },
                error: checkout.__error(actions['error'])
            });
        },
        shippingAddressSave: function(onSuccesed) {
            var checkout = this;

            $.ajax({
                url: 'index.php?route=checkout/simple/shippingAddressSave',
                method: 'post',
                dataType: 'json',
                data: checkout.shipping_address,
                beforeSend: function() {},
                success: function(json) {
                    if(json['redirect']) {
                        location = json['redirect'];
                    } else if(json['error']) {
                        console.warn('Shipping address save errors!', json['error']);
                    } else {
                        console.log('Shipping address save succesed!');
                        if(onSuccesed) onSuccesed(json);
                    }
                },
                error: function(xhr, ajaxOptions, thrownError) {
                    alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                }
            });
        },
        shippingMethodsGet: function(actions = {}) {
            var checkout = this;

            $.ajax({
                url: 'index.php?route=checkout/simple/shippingMethodsGet',
                data: checkout.shipping_address,
                dataType: 'html',
                beforeSend: actions['beforeSend'],
                success: function(html) {
                    console.log('Shipping methods load end!');
                    if(actions['success']) actions['success'](html);
                },
                error: checkout.__error(actions['error'])
            });
        },
        paymentMethodsGet: function(actions = {}) {
            var checkout = this;

            $.ajax({
                url: 'index.php?route=checkout/simple/paymentMethodsGet',
                dataType: 'html',
                beforeSend: actions['beforeSend'],
                success: function(html) {
                    console.log('Payments loaded!');
                    if(actions['success']) actions['success'](html);
                },
                error: checkout.__error(actions['error'])
            });
        },
        shippingAndPaymentsSave: function(actions = {}) {
            var checkout = this;

            $.ajax({
                url: 'index.php?route=checkout/simple/shippingAndPaymentsSave',
                method: 'post',
                data: _.merge(checkout.shipping_address, checkout.shipping_method, checkout.payment_method, checkout.terms, checkout.additional),
                dataType: 'json',
                beforeSend: actions['beforeSend'],
                beforeSend: function() {
                    if(actions['beforeSend']) actions['beforeSend']();
                },
                success: function(json) {
                    if(json['redirect']) {
                        location = json['redirect'];
                    } else if(json['error']){
                        if(actions['error']) actions['error'](json['error']);
                    } else {
                        if(actions['success']) actions['success'](json);
                    }
                },
                error: checkout.__error(actions['error']),
                complete: function() {
                    if(actions['complete']) actions['complete']();
                }
            });
        },
        confirm: function(actions = {}) {
            var checkout = this;

            $.ajax({
                url: 'index.php?route=checkout/simple/confirm',
                method: 'post',
                dataType: 'json',
                success: function(json) {
                    if(json['redirect']) {
                        location = json['redirect'];
                    } else {
                        if(actions['success']) actions['success'](json);
                    }
                },
                error: checkout.__error(actions['error'])
            });
        },
        paymentConfirm: function(actions = {}) {
            var checkout = this;

            $.ajax({
                url: 'index.php?route=extension/payment/cod/confirm',
                dataType: 'json',
                success: function(json) {
                    location = json['redirect'];
                },
                error: checkout.__error(actions['error'])
            });
        }
    };
</script>
{# Checkout model end #}

{# UI Delegate #}
<script type="text/javascript">
    $(document).delegate('#checkout-checkout .sInput', 'input', function(e) {
        var target = e.target;
        var group = $(target).data('group');
        var name = target.name;
        var value = target.value;

        if(checkout[group]) {
            checkout[group][name] = value;
        }
    });

    $(document).delegate('#checkout-checkout .select-box input', 'change', function(e) {
        var target = $(this);
        var type = target.attr('type');
        var group = target.data('group');
        var name = target.attr('name');
        var value = target.val();
        var checked = target.attr('checked');
        console.log('[select-box]', type, name, value, checked);

        if(checkout[group]) {
            if(type == 'radio') {
                checkout[group][name] = value; 

                if(group == 'shipping_method' && ui) {
                    ui.shippingMethodChange(value);
                }
            }

            if(type == 'checkbox') {
                checkout[group][name] = target.prop('checked');
            }
        }
    });

    $(document).delegate('#checkout-checkout .sDropdown select', 'change', function() {
        var target = $(this);
        var name = target.attr('name');
        var group = target.data('group');
        var value = target.val();
    
        if(checkout[group]) {
            checkout[group][name] = value;
        }
    });

    $(document).delegate('#button-login', 'click', function() {
        if(typeof ui) {
            ui.customerLogin();
        }
    });
</script>

{# Form events #}
<script type="text/javascript">
    var ui = {
        customerLogin: function() {
            var ui = this;

            if(checkout) {
                checkout.customerLogin({
                    beforeSend: ui.beforeSend('cart-checkout-login-login', function() {}),
                    success: function() {},
                    error: ui.displayErrors(function(errors) {})
                });
            }
        },
        customerSave: function() {
            var ui = this;
            if(checkout) {
                checkout.customerSave({
                    beforeSend: ui.beforeSend('cart-checkout-requisites', function() {}),
                    success: function(json) {
                        // go to Shipping and Payments
                        goTo(3);
                        $('a[href="#cart-checkout-payments"]').trigger('click');
                        $('#cart-button-next').prop('disabled', true);
                        nextButtonSet({ label: 'Оформить заказ', action: 'shippingAndPaymentsSave' })

                        checkout.shippingAddressGet({
                            success: function(html) {
                                $('#cart-checkout-requisites-shipping').html(html);

                                checkout.paymentMethodsGet({
                                    success: function(html) {
                                        $('#cart-checkout-payments-method').html(html);
                                    }
                                });
                            }
                        });
                    },
                    error: ui.displayErrors(function(errors) {})
                });
            }
        },
        shippingMethodChange: function(shippingMethodCode) {
            console.log('[shipping-method-change]', shippingMethodCode);

            $('select[data-code^="shipping"], input[data-code^="shipping"]')
                .parents('.sInput-container')
                .addClass('hidden');
            
            $('select[data-code$="' + shippingMethodCode + '"], input[data-code$="' + shippingMethodCode + '"]')
                .removeClass('sInput--error')
                .trigger('input')
                .change()
                .parents('.sInput-container')
                .removeClass('hidden')
                .find('.sInput-error')
                .remove();
        },
        shippingAndPaymentsSave: function() {
            if(checkout) {
                checkout.shippingAndPaymentsSave({
                    beforeSend: ui.beforeSend('cart-checkout-payments', function() {
                        $('#cart-button-next').prop('disabled', true);
                    }),
                    success: function(json) {
                        checkout.confirm({
                            success: function() {
                                checkout.paymentConfirm({
                                    success: function() {
                                        location = json['redirect'];
                                    }
                                });
                            }
                        });
                    },
                    error: ui.displayErrors(function(errors) {}),
                    complete: function() {
                        $('#cart-button-next').prop('disabled', false);
                    }
                });
            }
        },
        beforeSend: function(containerId, callback) {
            var ui = this;

            ui.container = $('#' + containerId);
            $(ui.container).find('.sInput-error').remove();
            $(ui.container).find('.sInput--error').removeClass('sInput--success sInput--error sInput--validate');

            if(callback) callback();
        },
        displayErrors: function(callback) {
            var ui = this;

            return function(errors) {
                _.forIn(errors, function(error, name) {
                    $(ui.container).find('input[type!="checkbox"][name$="' + name +'"], div[data-name$="' + name + '"]')
                        .addClass('sInput--error')
                        .after('<p class="sInput-error">' + error + '</p>');

                    $(ui.container).find('input[type="checkbox"][name$="' + name + '"], select[name$="' + name + '"]')
                        .addClass('sInput--error')
                        .parents('.select-box, .sInput-container')
                        .append('<p class="sInput-error">' + error + '</p>');
                });

                if(callback) callback(errors);
            }
        }
    };

    var shippingMethodsTimeout = null;
    $(document).delegate('#checkout-checkout .sInput[name$="city"]', 'input', function() {
        clearTimeout(shippingMethodsTimeout);

        shippingMethodsTimeout = setTimeout(function() {
            clearTimeout(shippingMethodsTimeout);

            if(checkout) {
                checkout.shippingMethodsGet({
                    success: function(html) {
                        console.log('Shipping methods load double check!');
                        $('#cart-checkout-requisites-shipping-method').html(html);
                        $('#cart-button-next').prop('disabled', false);
                    }
                });
            }
        }, 800);
    });
</script>
{# Form events end #}

{# Next button events #}
<script type="text/javascript">
    $(document).delegate('#cart-button-next', 'click', function(e) {
        e.preventDefault();

        var target = $(this);
        var action = target.attr('data-action');

        console.log(action);

        if(ui && action && ui[action]) ui[action]();
    });
</script>
{# Next button events end #}

{# Common form events #}
<script type="text/javascript">

</script>
{# Common form events end #}

{# {% if not logged %}
{% else %}
    <script type="text/javascript">
        $(document).ready(function() {
            goTo(3);
            $('a[href="#cart-checkout-payments"]').trigger('click');

            $.ajax({
                url: 'index.php?route=checkout/simple/shippingAddressGet',
                dataType: 'html',
                success: function(html) {
                    $('#cart-checkout-requisites-shipping').html(html);
                },
                error: function(xhr, ajaxOptions, thrownError) {
                    alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                }
            });

            $.ajax({
                url: 'index.php?route=checkout/simple/paymentMethodsGet',
                dataType: 'html',
                success: function(html) {
                    $('#cart-checkout-payments-method').html(html);
                },
                error: function(xhr, ajaxOptions, thrownError) {
                    alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                }
            });
        });
    </script>
{% endif %} #}


<script type="text/javascript"><!--
$(document).on('change', 'input[name=\'account\']', function() {
	if ($('#collapse-payment-address').parent().find('.panel-heading .panel-title > *').is('a')) {
		if (this.value == 'register') {
			$('#collapse-payment-address').parent().find('.panel-heading .panel-title').html('<a href="#collapse-payment-address" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_account }} <i class="fa fa-caret-down"></i></a>');
		} else {
			$('#collapse-payment-address').parent().find('.panel-heading .panel-title').html('<a href="#collapse-payment-address" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_payment_address }} <i class="fa fa-caret-down"></i></a>');
		}
	} else {
		if (this.value == 'register') {
			$('#collapse-payment-address').parent().find('.panel-heading .panel-title').html('{{ text_checkout_account }}');
		} else {
			$('#collapse-payment-address').parent().find('.panel-heading .panel-title').html('{{ text_checkout_payment_address }}');
		}
	}
});

$(document).delegate('#load-shipping-methods', 'click', loadShippingMethods);

function loadShippingMethods() {
    return $.ajax({
        url: 'index.php?route=checkout/simple/shippingMethodsGet',
        data: {
            'country_id': 0,
            'zone_id': 0,
        },
        dataType: 'html',
        complete: function() {
            
        },
        success: function(html) {
            $('#cart-checkout-requisites-shipping-method').html(html);
            console.log('Shipping methods load complete!');
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
}

function shippingAndPaymentsSave() {
    $.ajax({
        url: 'index.php?route=checkout/simple/shippingAndPaymentsSave',
        type: 'post',
        data: $('#cart-checkout-payments input[type="text"], #cart-checkout-payments input[type="hidden"], #cart-checkout-payments select, #cart-checkout-payments input[type="radio"]:checked, #cart-checkout-payments input[type="checkbox"]:checked, #cart-checkout-payments textarea'),
        dataType: 'json',
        success: function(json) {
            console.log(json);
            if (json['redirect']) {
                location = json['redirect'];
            } else if (json['error']) {
				for (i in json['error']) {
					console.error(json['error'][i]);
				}
            } else {
                console.log('ShippingAndPaymentsSave complete!');
                console.log(json);

                $.ajax({
                    url: 'index.php?route=checkout/simple/confirm',
                    type: 'post',
                    data: {},
                    dataType: 'json',
                    success: function(json) {
                        console.log(json);
                        if(json['redirect']) {
                            location = json['redirect'];
                        } else {
                            $.ajax({
                                url: 'index.php?route=extension/payment/cod/confirm',
                                dataType: 'json',
                                success: function(json) {
                                    console.log(json);
                                    location = json['redirect'];
                                },
                                error: function(xhr, ajaxOptions, thrownError) {
                                    alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                                }
                            });
                        }
                    },
                    error: function(xhr, ajaxOptions, thrownError) {
                        alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                    }
                });
            }
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
}

function saveShippingAddress() {
    $.ajax({
        url: 'index.php?route=checkout/simple/shippingAddressSave',
        type: 'post',
        data: $('#cart-checkout-requisites-shipping input[type="text"], #cart-checkout-requisites-shipping input[type="hidden"],  #cart-checkout-requisites-shipping select'),
        success: function(json) {
            console.log(json);
        }
    });
}

function savePaymentMethod() {
    $.ajax({
        url: 'index.php?route=checkout/simple/paymentMethodSave',
        type: 'post',
        data: $('#cart-checkout-payments-method textarea, #cart-checkout-payments-method select, #cart-checkout-payments-method input[type="checkbox"]:checked, #cart-checkout-payments-method input[type="radio"]:checked'),
        dataType: 'json',
        success: function(json) {
            console.log(json);
        }
    });
}

function confirmPaymentForm() {
    var errors = null;
    var fails = [];
    $.ajax({
        url: 'index.php?route=checkout/simple/shippingAddressSave',
        type: 'post',
        data: $('#cart-checkout-requisites-shipping input[type="text"], #cart-checkout-requisites-shipping input[type="hidden"], #cart-checkout-requisites-shipping select'),
        success: function(json) {
            errors = _.merge(errors, !_.isArray(json) ? json : null);
        },
        error: function(error) {
            fails.push(error);
            console.error(error);
        },
        complete: function() {
            $.ajax({
                url: 'index.php?route=checkout/simple/paymentMethodSave',
                type: 'post',
                data: $('#cart-checkout-payments-method textarea, #cart-checkout-payments-method select, #cart-checkout-payments-method input[type="checkbox"]:checked, #cart-checkout-payments-method input[type="radio"]:checked'),
                dataType: 'json',
                success: function(json) {
                    errors = _.merge(errors, !_.isArray(json) ? json : null);
                },
                error: function(error) {
                    fails.push(error);
                    console.error(error);
                },
                complete: function() {
                    if(!_.isEmpty(errors) || !_.isEmpty(fails)) {
                        console.log('Errors: ', errors);
                        console.log('Fails:', fails);
                    } else {
                        // confirm
                        $.ajax({
                            type: 'get',
                            url: 'index.php?route=checkout/simple/checkoutConfirm',
                            dataType: 'json',
                            success: function(json) {
                                console.log('Checkout result:', json);
                                if(json['redirect']) {
                                    location = json['redirect'];
                                } else {
                                    $.ajax({
                                        type: 'get',
                                        url: 'index.php?route=checkout/simple/checkoutPaymentConfirm',
                                        cache: false,
                                        success: function(data) {
                                            console.log(data);
                                            if(data['continue']) {
                                                location = data['continue'];
                                            }
                                        }
                                    });
                                }
                            },
                            error: function(error) {
                                console.error(error);
                            }
                        });


                        // $.ajax({
                        //     type: 'get',
                        //     url: 'index.php?route=checkout/simple/checkoutConfirm',
                        //     cache: false,
                        //     success: function(data) {
                        //         if(data['continue']) {
                        //             location = data['continue'];
                        //         }
                        //     }
                        // });
                    }
                }
            });
        }
    });
}

function guestInfoSave(callback = {}) {
    return $.ajax({
        url: 'index.php?route=checkout/simple/requisitesSave',
        type: 'post',
        data: $('#cart-checkout-login-guest input[type=\'text\'], #cart-checkout-login-guest input[type=\'email\'], #cart-checkout-login-guest input[type=\'phone\'], #cart-checkout-login-guest input[type=\'date\'], #cart-checkout-login-guest input[type=\'datetime-local\'], #cart-checkout-login-guest input[type=\'time\'], #cart-checkout-login-guest input[type=\'checkbox\']:checked, #cart-checkout-login-guest input[type=\'radio\']:checked, #cart-checkout-login-guest input[type=\'hidden\'], #cart-checkout-login-guest textarea, #cart-checkout-login-guest select'),
        dataType: 'json',
        beforeSend: function() {
            console.log('Guest data saving...');
        },
        success: function(json) {
            console.log('Guest data end saving.');

            if (json['redirect']) {
                location = json['redirect'];
            } else if (json['error']) {
				for (i in json['error']) {
					console.error(i);
                    if(callback.error) {
                        callback.error();
                    }
				}
            } else {
                console.log('Guest data save success!');
                
                $('a[href="#cart-checkout-payments"]').trigger('click');

                $.ajax({
                    url: 'index.php?route=checkout/simple/shippingAddressGet',
                    dataType: 'html',
                    success: function(html) {
                        $('#cart-checkout-requisites-shipping').html(html);
                    },
                    error: function(xhr, ajaxOptions, thrownError) {
                        alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                    }
                });

                $.ajax({
                    url: 'index.php?route=checkout/simple/paymentMethodsGet',
                    dataType: 'html',
                    success: function(html) {
                        $('#cart-checkout-payments-method').html(html);
                    },
                    error: function(xhr, ajaxOptions, thrownError) {
                        alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                    }
                });
            }
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
}

// Core methods
// Метод сохранения Адреса доставки
function shippingAddressSave() {
    $.ajax({
        url: 'index.php?route=checkout/shipping_address/save',
        type: 'post',
        data: $('#cart-checkout-requisites-shipping input[type=\'text\'], #cart-checkout-requisites-shipping input[type=\'hidden\'], #cart-checkout-requisites-shipping input[type=\'date\'], #cart-checkout-requisites-shipping input[type=\'datetime-local\'], #cart-checkout-requisites-shipping input[type=\'time\'], #cart-checkout-requisites-shipping input[type=\'password\'], #cart-checkout-requisites-shipping input[type=\'checkbox\']:checked, #cart-checkout-requisites-shipping input[type=\'radio\']:checked, #cart-checkout-requisites-shipping textarea, #cart-checkout-requisites-shipping select'),
        dataType: 'json',
        beforeSend: function() {
            $('#cart-checkout-requisites-shipping-method').html('Loading...');

            console.log('Shipping addres saving...');
        },
        success: function(json) {
            console.log('Shipping addres done.');

            if (json['redirect']) {
                location = json['redirect'];
            } else if (json['error']) {
                for (i in json['error']) {
                    console.error('Shipping address save error: ' + json['error'][i]);
                }
            } else {
                console.log('Shipping address save success!');

                $.ajax({
                    url: 'index.php?route=checkout/shipping_method',
                    dataType: 'html',
                    complete: function() {
                        $('#button-shipping-address').button('reset');
                    },
                    success: function(html) {
                        $('#cart-checkout-requisites-shipping-method').html(html);

                        $.ajax({
                            url: 'index.php?route=checkout/shipping_address',
                            dataType: 'html',
                            success: function(html) {
                                // $('#collapse-shipping-address .panel-body').html(html);
                            },
                            error: function(xhr, ajaxOptions, thrownError) {
                                alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                            }
                        });
                    },
                    error: function(xhr, ajaxOptions, thrownError) {
                        alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                    }
                }).done(function() {
                    $.ajax({
                        url: 'index.php?route=checkout/payment_address',
                        dataType: 'html',
                        success: function(html) {
                            $('#collapse-payment-address .panel-body').html(html);
                        },
                        error: function(xhr, ajaxOptions, thrownError) {
                            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                        }
                    });
                });
            }
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
}

function guestShippingAddressSave(callback) {
    return $.ajax({
        url: 'index.php?route=checkout/guest_shipping/save',
        type: 'post',
        data: $('#cart-checkout-requisites-shipping input[type=\'text\'], #cart-checkout-requisites-shipping input[type=\'hidden\'], #cart-checkout-requisites-shipping input[type=\'date\'], #cart-checkout-requisites-shipping input[type=\'datetime-local\'], #cart-checkout-requisites-shipping input[type=\'time\'], #cart-checkout-requisites-shipping input[type=\'password\'], #cart-checkout-requisites-shipping input[type=\'checkbox\']:checked, #cart-checkout-requisites-shipping input[type=\'radio\']:checked, #cart-checkout-requisites-shipping textarea, #cart-checkout-requisites-shipping select'),
        dataType: 'json',
        beforeSend: function() {
            console.log('Guset shipping saving...');
		},
        success: function(json) {
           console.log('Guset shipping saving end.');

            if (json['redirect']) {
                location = json['redirect'];
            } else if (json['error']) {

				for (i in json['error']) {
					console.error(i);
				}

            } else {
                console.log('Guset shipping saving success!');
                if(callback) {
                    callback();
                }
            }
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
}

function guestShippingAddressSave1() {
    var error = {};

    return $.ajax({
        url: 'index.php?route=checkout/guest_shipping/save',
        type: 'post',
        data: $('#cart-checkout-requisites-shipping input[type=\'text\'], #cart-checkout-requisites-shipping input[type=\'hidden\'], #cart-checkout-requisites-shipping input[type=\'date\'], #cart-checkout-requisites-shipping input[type=\'datetime-local\'], #cart-checkout-requisites-shipping input[type=\'time\'], #cart-checkout-requisites-shipping input[type=\'password\'], #cart-checkout-requisites-shipping input[type=\'checkbox\']:checked, #cart-checkout-requisites-shipping input[type=\'radio\']:checked, #cart-checkout-requisites-shipping textarea, #cart-checkout-requisites-shipping select'),
        dataType: 'json',
        beforeSend: function() {
            console.log('Guset shipping saving...');
		},
        success: function(json) {
           console.log('Guset shipping saving end.');

            if (json['redirect']) {
                location = json['redirect'];
            } else {
                _.merge(error, json['error']);

                $.ajax({
                    url: 'index.php?route=checkout/shipping_method',
                    dataType: 'html',
                    success: function() {
                        $.ajax({
                            url: 'index.php?route=checkout/shipping_method/save',
                            type: 'post',
                            data: $('#cart-checkout-requisites-shipping-method input[type=\'radio\']:checked, #cart-checkout-requisites-shipping-method textarea'),
                            dataType: 'json',
                            beforeSend: function() {
                                console.log('Shipping method saving...');
                            },
                            success: function(json) {
                                console.log('Shipping method saving end.');

                                if (json['redirect']) {
                                    location = json['redirect'];
                                } else {
                                    _.merge(error, json['error']);

                                    console.log('Done!');

                                    _.forIn(error, function(e) {
                                        console.error(e);
                                    });
                                }
                            },
                            error: function(xhr, ajaxOptions, thrownError) {
                                alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                            }
                        });
                    },
                    error: function(xhr, ajaxOptions, thrownError) {
                        alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                    }
                });
            }
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
}

function saveShippingMethod() {
    $.ajax({
        url: 'index.php?route=checkout/shipping_method/save',
        type: 'post',
        data: $('#cart-checkout-requisites-shipping-method input[type=\'radio\']:checked, #cart-checkout-requisites-shipping-method textarea'),
        dataType: 'json',
        beforeSend: function() {
        	console.log('Shipping method saving...');
		},
        success: function(json) {
            console.log('Shipping method saving end.');

            if (json['redirect']) {
                location = json['redirect'];
            } else if (json['error']) {
                console.error(json['error']['warning']);
            } else {
                console.log('Shipping method save success!');
            }
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
}


$(document).delegate('#cart-checkout-requisites-shipping-method input[name="shipping_method"]', 'change', function() {
    console.warn(this.value);
    // $.ajax({
    //     url: 'index.php?route=checkout/simple/shippingMethodSave',
    //     type: 'post',
    //     data: { 'shipping_method': this.value },
    //     dataType: 'json',
    //     success: function(json) {
    //         console.log(json);
    //     },
    //     error: function(e) {
    //         console.log(e);
    //     }
    // });
});


// Checkout
$(document).delegate('#button-account', 'click', function() {
    $.ajax({
        url: 'index.php?route=checkout/' + $('input[name=\'account\']:checked').val(),
        dataType: 'html',
        beforeSend: function() {
        	$('#button-account').button('loading');
		},
        complete: function() {
			$('#button-account').button('reset');
        },
        success: function(html) {
            $('.alert-dismissible, .text-danger').remove();
			$('.form-group').removeClass('has-error');

            $('#collapse-payment-address .panel-body').html(html);

			if ($('input[name=\'account\']:checked').val() == 'register') {
				$('#collapse-payment-address').parent().find('.panel-heading .panel-title').html('<a href="#collapse-payment-address" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_account }} <i class="fa fa-caret-down"></i></a>');
			} else {
				$('#collapse-payment-address').parent().find('.panel-heading .panel-title').html('<a href="#collapse-payment-address" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_payment_address }} <i class="fa fa-caret-down"></i></a>');
			}

			$('a[href=\'#collapse-payment-address\']').trigger('click');
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
});

// Login
{# $(document).delegate('#button-login', 'click', function() {
    $.ajax({
        url: 'index.php?route=checkout/login/save',
        type: 'post',
        data: $('#collapse-checkout-option :input'),
        dataType: 'json',
        beforeSend: function() {
        	$('#button-login').button('loading');
		},
        complete: function() {
            $('#button-login').button('reset');
        },
        success: function(json) {
            $('.alert-dismissible, .text-danger').remove();
            $('.form-group').removeClass('has-error');

            if (json['redirect']) {
                location = json['redirect'];
            } else if (json['error']) {
                $('#collapse-checkout-option .panel-body').prepend('<div class="alert alert-danger alert-dismissible"><i class="fa fa-exclamation-circle"></i> ' + json['error']['warning'] + '<button type="button" class="close" data-dismiss="alert">&times;</button></div>');

				// Highlight any found errors
				$('input[name=\'email\']').parent().addClass('has-error');
				$('input[name=\'password\']').parent().addClass('has-error');
		   }
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
}); #}

// Register
$(document).delegate('#button-register', 'click', function() {
    $.ajax({
        url: 'index.php?route=checkout/register/save',
        type: 'post',
        data: $('#collapse-payment-address input[type=\'text\'], #collapse-payment-address input[type=\'date\'], #collapse-payment-address input[type=\'datetime-local\'], #collapse-payment-address input[type=\'time\'], #collapse-payment-address input[type=\'password\'], #collapse-payment-address input[type=\'hidden\'], #collapse-payment-address input[type=\'checkbox\']:checked, #collapse-payment-address input[type=\'radio\']:checked, #collapse-payment-address textarea, #collapse-payment-address select'),
        dataType: 'json',
        beforeSend: function() {
			$('#button-register').button('loading');
		},
        success: function(json) {
            $('.alert-dismissible, .text-danger').remove();
            $('.form-group').removeClass('has-error');

            if (json['redirect']) {
                location = json['redirect'];
            } else if (json['error']) {
                $('#button-register').button('reset');

                if (json['error']['warning']) {
                    $('#collapse-payment-address .panel-body').prepend('<div class="alert alert-danger alert-dismissible"><i class="fa fa-exclamation-circle"></i> ' + json['error']['warning'] + '<button type="button" class="close" data-dismiss="alert">&times;</button></div>');
                }

				for (i in json['error']) {
					var element = $('#input-payment-' + i.replace('_', '-'));

					if ($(element).parent().hasClass('input-group')) {
						$(element).parent().after('<div class="text-danger">' + json['error'][i] + '</div>');
					} else {
						$(element).after('<div class="text-danger">' + json['error'][i] + '</div>');
					}
				}

				// Highlight any found errors
				$('.text-danger').parent().addClass('has-error');
            } else {
                {% if shipping_required %}
                var shipping_address = $('#payment-address input[name=\'shipping_address\']:checked').prop('value');

                if (shipping_address) {
                    $.ajax({
                        url: 'index.php?route=checkout/shipping_method',
                        dataType: 'html',
                        success: function(html) {
							// Add the shipping address
                            $.ajax({
                                url: 'index.php?route=checkout/shipping_address',
                                dataType: 'html',
                                success: function(html) {
                                    $('#collapse-shipping-address .panel-body').html(html);

									$('#collapse-shipping-address').parent().find('.panel-heading .panel-title').html('<a href="#collapse-shipping-address" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_shipping_address }} <i class="fa fa-caret-down"></i></a>');
                                },
                                error: function(xhr, ajaxOptions, thrownError) {
                                    alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                                }
                            });

							$('#collapse-shipping-method .panel-body').html(html);

							$('#collapse-shipping-method').parent().find('.panel-heading .panel-title').html('<a href="#collapse-shipping-method" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_shipping_method }} <i class="fa fa-caret-down"></i></a>');

   							$('a[href=\'#collapse-shipping-method\']').trigger('click');

							$('#collapse-shipping-method').parent().find('.panel-heading .panel-title').html('{{ text_checkout_shipping_method }}');
							$('#collapse-payment-method').parent().find('.panel-heading .panel-title').html('{{ text_checkout_payment_method }}');
							$('#collapse-checkout-confirm').parent().find('.panel-heading .panel-title').html('{{ text_checkout_confirm }}');
                        },
                        error: function(xhr, ajaxOptions, thrownError) {
                            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                        }
                    });
                } else {
                    $.ajax({
                        url: 'index.php?route=checkout/shipping_address',
                        dataType: 'html',
                        success: function(html) {
                            $('#collapse-shipping-address .panel-body').html(html);

							$('#collapse-shipping-address').parent().find('.panel-heading .panel-title').html('<a href="#collapse-shipping-address" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_shipping_address }} <i class="fa fa-caret-down"></i></a>');

							$('a[href=\'#collapse-shipping-address\']').trigger('click');

							$('#collapse-shipping-method').parent().find('.panel-heading .panel-title').html('{{ text_checkout_shipping_method }}');
							$('#collapse-payment-method').parent().find('.panel-heading .panel-title').html('{{ text_checkout_payment_method }}');
							$('#collapse-checkout-confirm').parent().find('.panel-heading .panel-title').html('{{ text_checkout_confirm }}');
                        },
                        error: function(xhr, ajaxOptions, thrownError) {
                            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                        }
                    });
                }
                {% else %}
                $.ajax({
                    url: 'index.php?route=checkout/payment_method',
                    dataType: 'html',
                    success: function(html) {
                        $('#collapse-payment-method .panel-body').html(html);

						$('#collapse-payment-method').parent().find('.panel-heading .panel-title').html('<a href="#collapse-payment-method" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_payment_method }} <i class="fa fa-caret-down"></i></a>');

						$('a[href=\'#collapse-payment-method\']').trigger('click');

						$('#collapse-checkout-confirm').parent().find('.panel-heading .panel-title').html('{{ text_checkout_confirm }}');
                    },
                    error: function(xhr, ajaxOptions, thrownError) {
                        alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                    }
                });
                {% endif %}

                $.ajax({
                    url: 'index.php?route=checkout/payment_address',
                    dataType: 'html',
                    complete: function() {
                        $('#button-register').button('reset');
                    },
                    success: function(html) {
                        $('#collapse-payment-address .panel-body').html(html);

						$('#collapse-payment-address').parent().find('.panel-heading .panel-title').html('<a href="#collapse-payment-address" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_payment_address }} <i class="fa fa-caret-down"></i></a>');
                    },
                    error: function(xhr, ajaxOptions, thrownError) {
                        alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                    }
                });
            }
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
});

// Payment Address
$(document).delegate('#button-payment-address', 'click', function() {
    $.ajax({
        url: 'index.php?route=checkout/payment_address/save',
        type: 'post',
        data: $('#collapse-payment-address input[type=\'text\'], #collapse-payment-address input[type=\'date\'], #collapse-payment-address input[type=\'datetime-local\'], #collapse-payment-address input[type=\'time\'], #collapse-payment-address input[type=\'password\'], #collapse-payment-address input[type=\'checkbox\']:checked, #collapse-payment-address input[type=\'radio\']:checked, #collapse-payment-address input[type=\'hidden\'], #collapse-payment-address textarea, #collapse-payment-address select'),
        dataType: 'json',
        beforeSend: function() {
        	$('#button-payment-address').button('loading');
		},
        complete: function() {
			$('#button-payment-address').button('reset');
        },
        success: function(json) {
            $('.alert-dismissible, .text-danger').remove();
			$('.form-group').removeClass('has-error');

            if (json['redirect']) {
                location = json['redirect'];
            } else if (json['error']) {
                if (json['error']['warning']) {
                    $('#collapse-payment-address .panel-body').prepend('<div class="alert alert-warning alert-dismissible">' + json['error']['warning'] + '<button type="button" class="close" data-dismiss="alert">&times;</button></div>');
                }

				for (i in json['error']) {
					var element = $('#input-payment-' + i.replace('_', '-'));

					if ($(element).parent().hasClass('input-group')) {
						$(element).parent().after('<div class="text-danger">' + json['error'][i] + '</div>');
					} else {
						$(element).after('<div class="text-danger">' + json['error'][i] + '</div>');
					}
				}

				// Highlight any found errors
				$('.text-danger').parent().parent().addClass('has-error');
            } else {
                {% if shipping_required %}
                $.ajax({
                    url: 'index.php?route=checkout/shipping_address',
                    dataType: 'html',
                    success: function(html) {
                        $('#collapse-shipping-address .panel-body').html(html);

						$('#collapse-shipping-address').parent().find('.panel-heading .panel-title').html('<a href="#collapse-shipping-address" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_shipping_address }} <i class="fa fa-caret-down"></i></a>');

						$('a[href=\'#collapse-shipping-address\']').trigger('click');

						$('#collapse-shipping-method').parent().find('.panel-heading .panel-title').html('{{ text_checkout_shipping_method }}');
						$('#collapse-payment-method').parent().find('.panel-heading .panel-title').html('{{ text_checkout_payment_method }}');
						$('#collapse-checkout-confirm').parent().find('.panel-heading .panel-title').html('{{ text_checkout_confirm }}');
                    },
                    error: function(xhr, ajaxOptions, thrownError) {
                        alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                    }
                }).done(function() {
					$.ajax({
						url: 'index.php?route=checkout/payment_address',
						dataType: 'html',
						success: function(html) {
							$('#collapse-payment-address .panel-body').html(html);
						},
						error: function(xhr, ajaxOptions, thrownError) {
							alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
						}
					});
				});
                {% else %}
                $.ajax({
                    url: 'index.php?route=checkout/payment_method',
                    dataType: 'html',
                    success: function(html) {
                        $('#collapse-payment-method .panel-body').html(html);

						$('#collapse-payment-method').parent().find('.panel-heading .panel-title').html('<a href="#collapse-payment-method" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_payment_method }} <i class="fa fa-caret-down"></i></a>');

						$('a[href=\'#collapse-payment-method\']').trigger('click');

						$('#collapse-checkout-confirm').parent().find('.panel-heading .panel-title').html('{{ text_checkout_confirm }}');
                    },
                    error: function(xhr, ajaxOptions, thrownError) {
                        alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                    }
                }).done(function() {
					$.ajax({
						url: 'index.php?route=checkout/payment_address',
						dataType: 'html',
						success: function(html) {
							$('#collapse-payment-address .panel-body').html(html);
						},
						error: function(xhr, ajaxOptions, thrownError) {
							alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
						}
					});				
				});
                {% endif %}
            }
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
});

// Событие после нажатия кнопки Адреса доставки
// В данном методе сохраняется адрес доставки
// Shipping Address
$(document).delegate('#button-shipping-address', 'click', function() {
    shippingAddressSave();
});

// Guest
$(document).delegate('#button-guest', 'click', function() {
    $.ajax({
        url: 'index.php?route=checkout/guest/save',
        type: 'post',
        data: $('#collapse-payment-address input[type=\'text\'], #collapse-payment-address input[type=\'date\'], #collapse-payment-address input[type=\'datetime-local\'], #collapse-payment-address input[type=\'time\'], #collapse-payment-address input[type=\'checkbox\']:checked, #collapse-payment-address input[type=\'radio\']:checked, #collapse-payment-address input[type=\'hidden\'], #collapse-payment-address textarea, #collapse-payment-address select'),
        dataType: 'json',
        beforeSend: function() {
       		$('#button-guest').button('loading');
	    },
        success: function(json) {
            $('.alert-dismissible, .text-danger').remove();
			$('.form-group').removeClass('has-error');

            if (json['redirect']) {
                location = json['redirect'];
            } else if (json['error']) {
                $('#button-guest').button('reset');

                if (json['error']['warning']) {
                    $('#collapse-payment-address .panel-body').prepend('<div class="alert alert-warning alert-dismissible">' + json['error']['warning'] + '<button type="button" class="close" data-dismiss="alert">&times;</button></div>');
                }

				for (i in json['error']) {
					var element = $('#input-payment-' + i.replace('_', '-'));

					if ($(element).parent().hasClass('input-group')) {
						$(element).parent().after('<div class="text-danger">' + json['error'][i] + '</div>');
					} else {
						$(element).after('<div class="text-danger">' + json['error'][i] + '</div>');
					}
				}

				// Highlight any found errors
				$('.text-danger').parent().addClass('has-error');
            } else {
                {% if shipping_required %}
                var shipping_address = $('#collapse-payment-address input[name=\'shipping_address\']:checked').prop('value');

                if (shipping_address) {
                    $.ajax({
                        url: 'index.php?route=checkout/shipping_method',
                        dataType: 'html',
                        complete: function() {
                            $('#button-guest').button('reset');
                        },
                        success: function(html) {
							// Add the shipping address
                            $.ajax({
                                url: 'index.php?route=checkout/guest_shipping',
                                dataType: 'html',
                                success: function(html) {
                                    $('#collapse-shipping-address .panel-body').html(html);

									$('#collapse-shipping-address').parent().find('.panel-heading .panel-title').html('<a href="#collapse-shipping-address" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_shipping_address }} <i class="fa fa-caret-down"></i></a>');
                                },
                                error: function(xhr, ajaxOptions, thrownError) {
                                    alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                                }
                            });

						    $('#collapse-shipping-method .panel-body').html(html);

							$('#collapse-shipping-method').parent().find('.panel-heading .panel-title').html('<a href="#collapse-shipping-method" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_shipping_method }} <i class="fa fa-caret-down"></i></a>');

							$('a[href=\'#collapse-shipping-method\']').trigger('click');

							$('#collapse-payment-method').parent().find('.panel-heading .panel-title').html('{{ text_checkout_payment_method }}');
							$('#collapse-checkout-confirm').parent().find('.panel-heading .panel-title').html('{{ text_checkout_confirm }}');
                        },
                        error: function(xhr, ajaxOptions, thrownError) {
                            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                        }
                    });
                } else {
                    $.ajax({
                        url: 'index.php?route=checkout/guest_shipping',
                        dataType: 'html',
                        complete: function() {
                            $('#button-guest').button('reset');
                        },
                        success: function(html) {
                            $('#collapse-shipping-address .panel-body').html(html);

							$('#collapse-shipping-address').parent().find('.panel-heading .panel-title').html('<a href="#collapse-shipping-address" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_shipping_address }} <i class="fa fa-caret-down"></i></a>');

							$('a[href=\'#collapse-shipping-address\']').trigger('click');

							$('#collapse-shipping-method').parent().find('.panel-heading .panel-title').html('{{ text_checkout_shipping_method }}');
							$('#collapse-payment-method').parent().find('.panel-heading .panel-title').html('{{ text_checkout_payment_method }}');
							$('#collapse-checkout-confirm').parent().find('.panel-heading .panel-title').html('{{ text_checkout_confirm }}');
                        },
                        error: function(xhr, ajaxOptions, thrownError) {
                            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                        }
                    });
                }
                {% else %}
                $.ajax({
                    url: 'index.php?route=checkout/payment_method',
                    dataType: 'html',
                    complete: function() {
                        $('#button-guest').button('reset');
                    },
                    success: function(html) {
                        $('#collapse-payment-method .panel-body').html(html);

						$('#collapse-payment-method').parent().find('.panel-heading .panel-title').html('<a href="#collapse-payment-method" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_payment_method }} <i class="fa fa-caret-down"></i></a>');

						$('a[href=\'#collapse-payment-method\']').trigger('click');

						$('#collapse-checkout-confirm').parent().find('.panel-heading .panel-title').html('{{ text_checkout_confirm }}');
                    },
                    error: function(xhr, ajaxOptions, thrownError) {
                        alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                    }
                });
                {% endif %}
            }
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
});

// Guest Shipping
$(document).delegate('#button-guest-shipping', 'click', function() {
    $.ajax({
        url: 'index.php?route=checkout/guest_shipping/save',
        type: 'post',
        data: $('#collapse-shipping-address input[type=\'text\'], #collapse-shipping-address input[type=\'date\'], #collapse-shipping-address input[type=\'datetime-local\'], #collapse-shipping-address input[type=\'time\'], #collapse-shipping-address input[type=\'password\'], #collapse-shipping-address input[type=\'checkbox\']:checked, #collapse-shipping-address input[type=\'radio\']:checked, #collapse-shipping-address textarea, #collapse-shipping-address select'),
        dataType: 'json',
        beforeSend: function() {
        	$('#button-guest-shipping').button('loading');
		},
        success: function(json) {
            $('.alert-dismissible, .text-danger').remove();
			$('.form-group').removeClass('has-error');

            if (json['redirect']) {
                location = json['redirect'];
            } else if (json['error']) {
                $('#button-guest-shipping').button('reset');

                if (json['error']['warning']) {
                    $('#collapse-shipping-address .panel-body').prepend('<div class="alert alert-danger alert-dismissible">' + json['error']['warning'] + '<button type="button" class="close" data-dismiss="alert">&times;</button></div>');
                }

				for (i in json['error']) {
					var element = $('#input-shipping-' + i.replace('_', '-'));

					if ($(element).parent().hasClass('input-group')) {
						$(element).parent().after('<div class="text-danger">' + json['error'][i] + '</div>');
					} else {
						$(element).after('<div class="text-danger">' + json['error'][i] + '</div>');
					}
				}

				// Highlight any found errors
				$('.text-danger').parent().addClass('has-error');
            } else {
                $.ajax({
                    url: 'index.php?route=checkout/shipping_method',
                    dataType: 'html',
                    complete: function() {
                        $('#button-guest-shipping').button('reset');
                    },
                    success: function(html) {
                        $('#collapse-shipping-method .panel-body').html(html);

						$('#collapse-shipping-method').parent().find('.panel-heading .panel-title').html('<a href="#collapse-shipping-method" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_shipping_method }} <i class="fa fa-caret-down"></i>');

						$('a[href=\'#collapse-shipping-method\']').trigger('click');

						$('#collapse-payment-method').parent().find('.panel-heading .panel-title').html('{{ text_checkout_payment_method }}');
						$('#collapse-checkout-confirm').parent().find('.panel-heading .panel-title').html('{{ text_checkout_confirm }}');
                    },
                    error: function(xhr, ajaxOptions, thrownError) {
                        alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                    }
                });
            }
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
});

$(document).delegate('#button-shipping-method', 'click', function() {
    ShippingMethodSave();
});

$(document).delegate('#button-payment-method', 'click', function() {
    $.ajax({
        url: 'index.php?route=checkout/payment_method/save',
        type: 'post',
        data: $('#collapse-payment-method input[type=\'radio\']:checked, #collapse-payment-method input[type=\'checkbox\']:checked, #collapse-payment-method textarea'),
        dataType: 'json',
        beforeSend: function() {
         	$('#button-payment-method').button('loading');
		},
        success: function(json) {
            $('.alert-dismissible, .text-danger').remove();

            if (json['redirect']) {
                location = json['redirect'];
            } else if (json['error']) {
                $('#button-payment-method').button('reset');
                
                if (json['error']['warning']) {
                    $('#collapse-payment-method .panel-body').prepend('<div class="alert alert-danger alert-dismissible">' + json['error']['warning'] + '<button type="button" class="close" data-dismiss="alert">&times;</button></div>');
                }
            } else {
                $.ajax({
                    url: 'index.php?route=checkout/confirm',
                    dataType: 'html',
                    complete: function() {
                        $('#button-payment-method').button('reset');
                    },
                    success: function(html) {
                        $('#collapse-checkout-confirm .panel-body').html(html);

						$('#collapse-checkout-confirm').parent().find('.panel-heading .panel-title').html('<a href="#collapse-checkout-confirm" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_confirm }} <i class="fa fa-caret-down"></i></a>');

						$('a[href=\'#collapse-checkout-confirm\']').trigger('click');
					},
                    error: function(xhr, ajaxOptions, thrownError) {
                        alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                    }
                });
            }
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
});
//--></script>


{# Скрипты для UI #}
<script type="text/javascript">
    // var cartCheckoutRequisitesShipping = {
    //     timeout: null
    // }

    // var cartCheckoutRequisitesShipping
    // $(document).on('input', '#cart-checkout-requisites-shipping input[type="text"]', function(e) {
    //     var name = e.target.name;
    //     var value = e.target.value;
    //     console.log(name, value);

    //     clearTimeout(cartCheckoutRequisitesShipping.timeout);
    //     cartCheckoutRequisitesShipping.timeout = null;

    //     cartCheckoutRequisitesShipping.timeout = setTimeout(function() {
    //         {% if not login %}
    //             guestShippingAddressSave(loadShippingMethod);
    //         {% else %}
    //             shippingAddressSave(loadShippingMethod);
    //         {% endif %}

    //         clearTimeout(cartCheckoutRequisitesShipping.timeout);
    //         cartCheckoutRequisitesShipping.timeout = null;
    //     }, 800);
    // });
</script>












{{ footer }}